---
import type { Locale } from "../i18n";
import { pick } from "../i18n";
import { careerTimeline } from "../data/career";

const { locale } = Astro.props as { locale: Locale };

const copy = {
  fr: {
    title: "Parcours",
    subtitle: "15+ ans de craft",
    scrollHint: "Scroll",
  },
  en: {
    title: "Journey",
    subtitle: "15+ years of craft",
    scrollHint: "Scroll",
  },
};

const t = copy[locale];

// Group events by year for cleaner display
const groupedByYear = careerTimeline.reduce((acc, event) => {
  const year = event.year.split("-")[0];
  if (!acc[year]) acc[year] = [];
  acc[year].push(event);
  return acc;
}, {} as Record<string, typeof careerTimeline>);

const years = Object.keys(groupedByYear).sort((a, b) => parseInt(b) - parseInt(a));

const typeLabels: Record<string, Record<string, string>> = {
  fr: { job: "Poste", project: "Projet", milestone: "Milestone", education: "Formation" },
  en: { job: "Role", project: "Project", milestone: "Milestone", education: "Education" },
};
---

<section id="journey" class="relative py-16" aria-labelledby="journey-title">
  <div class="absolute left-0 right-0 top-0 flex items-center gap-4">
    <div class="h-px flex-1 bg-gradient-to-r from-transparent via-[rgb(var(--border))] to-transparent"></div>
  </div>

  <!-- Header -->
  <div class="animate-on-scroll mb-12">
    <span class="text-xs font-medium uppercase tracking-widest text-[rgb(var(--accent-tertiary))]">00</span>
    <h2 id="journey-title" class="mt-2 text-3xl font-bold tracking-tight text-[rgb(var(--text-primary))] md:text-4xl">{t.title}</h2>
    <p class="mt-3 max-w-md text-[rgb(var(--text-secondary))]">{t.subtitle}</p>
  </div>

  <!-- Scroll hint -->
  <div class="animate-on-scroll stagger-1 mb-6 flex items-center gap-2 text-xs font-medium uppercase tracking-widest text-[rgb(var(--text-tertiary))]">
    <span>{t.scrollHint}</span>
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="arrow-bounce">
      <path d="M3 8h10M9 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>

  <!-- Timeline container -->
  <div class="timeline-container relative -mx-6 overflow-x-auto overflow-y-hidden px-6 pb-4" style="scrollbar-width: none; -ms-overflow-style: none;">
    <div class="timeline-track flex items-start" style="width: max-content;">
      {years.map((year, index) => (
        <div
          class="timeline-item group relative flex-shrink-0"
          style={`--index: ${index};`}
          data-year={year}
        >
          <div class="relative flex w-[300px] flex-col md:w-[380px]">
            <!-- Year label - clearly visible -->
            <div class="mb-6 px-6">
              <span class="year-label font-mono text-3xl font-bold tracking-tight text-[rgb(var(--text-primary))] transition-colors duration-300 md:text-4xl">
                '{year.slice(2)}
              </span>
            </div>

            <!-- Timeline line + dot -->
            <div class="relative mb-8 px-6">
              <!-- Horizontal line -->
              <div class="absolute left-0 right-0 top-[7px] h-px bg-[rgb(var(--border))]"></div>
              <!-- Dot marker -->
              <div class="relative z-10 flex items-center">
                <div class="timeline-dot h-[14px] w-[14px] rounded-full border-[2.5px] border-[rgb(var(--accent))] bg-[rgb(var(--bg-primary))] transition-all duration-200 group-hover:bg-[rgb(var(--accent))] group-hover:shadow-[0_0_0_4px_rgb(var(--accent)/0.12)]"></div>
                <span class="ml-3 font-mono text-xs font-medium text-[rgb(var(--text-tertiary))] transition-colors duration-200 group-hover:text-[rgb(var(--accent))]">
                  {year}
                </span>
              </div>
            </div>

            <!-- Content cards -->
            <div class="space-y-3 px-6">
              {groupedByYear[year].map((event, eventIndex) => (
                <div
                  class="card-reveal translate-y-3 opacity-0 transition-all duration-500 ease-out"
                  style={`transition-delay: ${eventIndex * 80}ms;`}
                >
                  <div class="timeline-card rounded-lg border border-[rgb(var(--border)/0.6)] bg-[rgb(var(--bg-secondary))] p-4 transition-all duration-200 hover:border-[rgb(var(--accent)/0.4)] hover:shadow-[0_2px_12px_rgb(var(--accent)/0.06)]">
                    <!-- Type + Company row -->
                    <div class="mb-2 flex items-center gap-2">
                      <span class={`inline-block rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wider ${
                        event.type === 'job'
                          ? 'bg-[rgb(var(--accent)/0.1)] text-[rgb(var(--accent))]'
                          : event.type === 'project'
                          ? 'bg-[rgb(var(--accent-secondary)/0.1)] text-[rgb(var(--accent-secondary))]'
                          : event.type === 'milestone'
                          ? 'bg-emerald-500/10 text-emerald-600 dark:text-emerald-400'
                          : 'bg-[rgb(var(--accent-tertiary)/0.1)] text-[rgb(var(--accent-tertiary))]'
                      }`}>
                        {typeLabels[locale][event.type]}
                      </span>
                      {event.company && (
                        <span class="text-xs text-[rgb(var(--text-tertiary))]">{event.company}</span>
                      )}
                    </div>

                    <!-- Title -->
                    <h3 class="text-sm font-semibold leading-snug text-[rgb(var(--text-primary))]">
                      {pick(event.title, locale)}
                    </h3>

                    <!-- Description -->
                    <p class="mt-1.5 text-[13px] leading-relaxed text-[rgb(var(--text-secondary))]">
                      {pick(event.description, locale)}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      ))}

      <!-- End spacer -->
      <div class="w-16 flex-shrink-0"></div>
    </div>
  </div>
</section>

<style>
  .timeline-container::-webkit-scrollbar {
    display: none;
  }

  /* Reveal cards when in view */
  .timeline-item.in-view .card-reveal {
    opacity: 1;
    transform: translateY(0);
  }

  /* Year label parallax */
  .year-label {
    will-change: transform;
    display: inline-block;
  }

  /* Active state for current item in view */
  .timeline-item.in-view .timeline-dot {
    background-color: rgb(var(--accent));
    box-shadow: 0 0 0 4px rgb(var(--accent) / 0.1);
  }

  /* Card subtle interaction */
  .timeline-card {
    will-change: border-color, box-shadow;
  }
</style>

<script>
  const initTimeline = () => {
    const container = document.querySelector('.timeline-container');
    const items = document.querySelectorAll('.timeline-item');

    if (!container || !items.length) return;

    // Intersection observer for card reveals
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('in-view');
          }
        });
      },
      {
        root: container,
        threshold: 0.3,
      }
    );

    items.forEach((item) => observer.observe(item));

    // Smooth horizontal scroll with mouse wheel
    container.addEventListener('wheel', (e) => {
      if (Math.abs((e as WheelEvent).deltaY) > Math.abs((e as WheelEvent).deltaX)) {
        e.preventDefault();
        container.scrollLeft += (e as WheelEvent).deltaY;
      }
    }, { passive: false });

    // Subtle parallax on year labels
    container.addEventListener('scroll', () => {
      items.forEach((item) => {
        const label = item.querySelector('.year-label') as HTMLElement;
        if (label) {
          const rect = item.getBoundingClientRect();
          const center = window.innerWidth / 2;
          const offset = (rect.left - center) * 0.02;
          label.style.transform = `translateX(${offset}px)`;
        }
      });
    });
  };

  initTimeline();
  document.addEventListener('astro:page-load', initTimeline);
</script>
