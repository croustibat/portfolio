---
import { ViewTransitions } from "astro:transitions";
import "../styles/global.css";

const {
  title = "Baptiste Bouillot — Portfolio",
  description = "Product Engineer / CTO — open-source & macOS experiments.",
  ogType = "website",
  ogImage,
  locale,
} = Astro.props;

const pathname = Astro.url.pathname;
const strippedPath = pathname.replace(/^\/(fr|en)(?=\/|$)/, "");
const currentLocale = locale ?? (pathname.startsWith("/en") ? "en" : "fr");
const basePath = currentLocale === "fr" ? "/fr" : "/en";
const frPath = `/fr${strippedPath || ""}`;
const enPath = `/en${strippedPath || ""}`;
const canonicalPath = currentLocale === "fr" ? frPath : enPath;

const canonicalUrl = Astro.site ? new URL(canonicalPath, Astro.site).toString() : null;
const frUrl = Astro.site ? new URL(frPath, Astro.site).toString() : null;
const enUrl = Astro.site ? new URL(enPath, Astro.site).toString() : null;
const ogImageUrl = Astro.site
  ? new URL(ogImage ?? "/images/og-default.svg", Astro.site).toString()
  : ogImage ?? "/images/og-default.svg";

const nav =
  currentLocale === "fr"
    ? {
        work: "Projets",
        oss: "Open source",
        music: "Musique",
        contact: "Contact",
        download: "Télécharger PDF",
        switchLabel: "EN",
        switchAria: "Switch to English",
      }
    : {
        work: "Work",
        oss: "Open-source",
        music: "Music",
        contact: "Contact",
        download: "Download PDF",
        switchLabel: "FR",
        switchAria: "Basculer en français",
      };

const switchHref = currentLocale === "fr" ? enPath : frPath;
---

<!doctype html>
<html lang={currentLocale} class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <meta name="theme-color" content="#7C3AED" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    {canonicalUrl ? <meta property="og:url" content={canonicalUrl} /> : null}
    {ogImageUrl ? <meta property="og:image" content={ogImageUrl} /> : null}
    <meta name="twitter:card" content={ogImageUrl ? "summary_large_image" : "summary"} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImageUrl ? <meta name="twitter:image" content={ogImageUrl} /> : null}
    {canonicalUrl ? <link rel="canonical" href={canonicalUrl} /> : null}
    {frUrl ? <link rel="alternate" hreflang="fr" href={frUrl} /> : null}
    {enUrl ? <link rel="alternate" hreflang="en" href={enUrl} /> : null}
    {frUrl ? <link rel="alternate" hreflang="x-default" href={frUrl} /> : null}

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="114947c9-0a31-47be-8353-ab2b4eb0c95c"></script>

    <!-- View Transitions -->
    <ViewTransitions />

    <!-- Dark mode script (before render to prevent flash) -->
    <script is:inline>
      (function() {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (stored === 'dark' || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
  </head>

  <body class="bg-[rgb(var(--bg-primary))] text-[rgb(var(--text-primary))] transition-colors duration-300">
    {/* Creative layered background */}
    <div class="pointer-events-none fixed inset-0 overflow-hidden">
      {/* Dot grid pattern */}
      <div class="absolute inset-0 opacity-[0.04] [background-image:radial-gradient(#000_1px,transparent_1px)] [background-size:24px_24px]"></div>
      {/* Gradient orbs */}
      <div class="absolute -left-1/4 top-0 h-[600px] w-[600px] rounded-full bg-gradient-to-br from-[rgb(var(--accent)/0.08)] to-transparent blur-3xl"></div>
      <div class="absolute -right-1/4 top-1/3 h-[500px] w-[500px] rounded-full bg-gradient-to-bl from-[rgb(var(--accent-secondary)/0.06)] to-transparent blur-3xl"></div>
      <div class="absolute bottom-0 left-1/3 h-[400px] w-[400px] rounded-full bg-gradient-to-t from-[rgb(var(--accent-tertiary)/0.05)] to-transparent blur-3xl"></div>
    </div>

    <header class="relative mx-auto max-w-6xl px-6 py-8">
      <nav class="flex items-center justify-between">
        <a href="/" class="group text-lg font-bold tracking-tight transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-[rgb(var(--accent))]">
          <span class="bg-gradient-to-r from-[rgb(var(--text-primary))] via-[rgb(var(--text-primary))] to-[rgb(var(--text-primary))] bg-clip-text transition-all group-hover:from-[rgb(var(--accent))] group-hover:via-[rgb(var(--accent-secondary))] group-hover:to-[rgb(var(--accent-tertiary))] group-hover:text-transparent">baptiste</span><span class="text-[rgb(var(--text-tertiary))]">.ultraviolettes</span>
        </a>

        <div class="flex items-center gap-1 text-sm">
          <a href={`${basePath}#work`} class="rounded-lg px-3 py-2 text-[rgb(var(--text-secondary))] transition hover:bg-[rgb(var(--bg-tertiary))] hover:text-[rgb(var(--text-primary))] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[rgb(var(--accent))]">{nav.work}</a>
          <a href={`${basePath}#oss`} class="rounded-lg px-3 py-2 text-[rgb(var(--text-secondary))] transition hover:bg-[rgb(var(--bg-tertiary))] hover:text-[rgb(var(--text-primary))] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[rgb(var(--accent))]">{nav.oss}</a>
          <a href={`${basePath}/music`} class="rounded-lg px-3 py-2 text-[rgb(var(--text-secondary))] transition hover:bg-[rgb(var(--bg-tertiary))] hover:text-[rgb(var(--text-primary))] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[rgb(var(--accent))]">{nav.music}</a>
          <a href={`${basePath}#contact`} class="rounded-lg px-3 py-2 text-[rgb(var(--text-secondary))] transition hover:bg-[rgb(var(--bg-tertiary))] hover:text-[rgb(var(--text-primary))] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[rgb(var(--accent))]">{nav.contact}</a>
          <div class="mx-2 h-4 w-px bg-[rgb(var(--border))]"></div>
          <a
            href={switchHref}
            class="rounded-lg px-3 py-2 text-xs font-medium text-[rgb(var(--text-tertiary))] transition hover:bg-[rgb(var(--bg-tertiary))] hover:text-[rgb(var(--text-primary))] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[rgb(var(--accent))]"
            aria-label={nav.switchAria}
          >
            {nav.switchLabel}
          </a>
          <button
            id="theme-toggle"
            type="button"
            class="rounded-lg p-2 text-[rgb(var(--text-tertiary))] transition hover:bg-[rgb(var(--bg-tertiary))] hover:text-[rgb(var(--text-primary))] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[rgb(var(--accent))]"
            aria-label="Toggle dark mode"
          >
            <svg class="hidden h-5 w-5 dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg class="block h-5 w-5 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </button>
          <a href="/pdf/CV_Baptiste.pdf" download
             class="ml-2 rounded-full bg-[rgb(var(--text-primary))] px-4 py-2 text-xs font-medium text-[rgb(var(--bg-primary))] transition hover:opacity-80 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[rgb(var(--accent))]">
            {nav.download}
          </a>
        </div>
      </nav>
    </header>

    <main class="relative mx-auto max-w-6xl px-6">
      <slot />
    </main>

    <footer class="relative mx-auto max-w-6xl px-6 pb-12 pt-8 text-sm">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <p class="text-[rgb(var(--text-secondary))]">© {new Date().getFullYear()} Baptiste Bouillot</p>
        <p class="flex items-center gap-2 text-[rgb(var(--text-tertiary))]">
          <span class="h-1.5 w-1.5 rounded-full bg-gradient-to-r from-[rgb(var(--accent))] to-[rgb(var(--accent-secondary))]"></span>
          Built with Astro + Tailwind
        </p>
      </div>
    </footer>

    <script>
      // Scroll animations with Intersection Observer
      const initScrollAnimations = () => {
        const animatedElements = document.querySelectorAll(
          '.animate-on-scroll, .animate-fade, .animate-slide-left, .animate-slide-right, .animate-scale'
        );

        if (!animatedElements.length) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                // Optionally unobserve after animation (better performance)
                observer.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.1, // Trigger when 10% visible
            rootMargin: '0px 0px -50px 0px' // Trigger slightly before fully in view
          }
        );

        animatedElements.forEach((el) => observer.observe(el));
      };

      // Run on initial load
      initScrollAnimations();

      // Re-run after Astro page transitions (View Transitions API)
      document.addEventListener('astro:page-load', initScrollAnimations);

      // Spotlight effect - glow follows cursor on cards
      const initSpotlightEffect = () => {
        const cards = document.querySelectorAll('.spotlight-card');

        cards.forEach((card) => {
          const spotlight = card.querySelector('.spotlight-gradient') as HTMLElement;
          if (!spotlight) return;

          card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            const x = (e as MouseEvent).clientX - rect.left;
            const y = (e as MouseEvent).clientY - rect.top;

            spotlight.style.left = `${x}px`;
            spotlight.style.top = `${y}px`;
          });

          card.addEventListener('mouseleave', () => {
            // Reset position when mouse leaves
            spotlight.style.left = '50%';
            spotlight.style.top = '50%';
          });
        });
      };

      // Run on initial load
      initSpotlightEffect();

      // Re-run after Astro page transitions
      document.addEventListener('astro:page-load', initSpotlightEffect);

      // Dark mode toggle
      const initThemeToggle = () => {
        const toggle = document.getElementById('theme-toggle');
        if (!toggle) return;

        toggle.addEventListener('click', () => {
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
      };

      initThemeToggle();
      document.addEventListener('astro:page-load', initThemeToggle);
    </script>
  </body>
</html>
